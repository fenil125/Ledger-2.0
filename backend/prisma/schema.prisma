// Prisma Schema for Ledger Application
// Database: PostgreSQL (Neon serverless)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model - stores application users with profile images
model User {
  id           String        @id @default(cuid())
  email        String        @unique
  name         String
  password     String
  role         String        @default("user") // 'admin' or 'user'
  profileImage String?       // Cloudinary URL
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  
  // Relations
  transactions  Transaction[]
  parties       Party[]       @relation("CreatedParties")
  notifications Notification[]
  
  @@index([email])
}

// Party model - customers/vendors with contact info and images
model Party {
  id          String        @id @default(cuid())
  name        String
  phone       String
  email       String?
  address     String?
  notes       String?
  image       String?       // Cloudinary URL for party photo/logo
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  // Relations
  createdBy   String
  creator     User          @relation("CreatedParties", fields: [createdBy], references: [id])
  transactions Transaction[]
  partyPayments PartyPayment[]
  
  @@index([phone])
  @@index([name])
  @@index([createdBy])
}

// Party-level payment - not tied to specific transaction (lump-sum payments)
model PartyPayment {
  id            String    @id @default(cuid())
  partyId       String
  party         Party     @relation(fields: [partyId], references: [id], onDelete: Cascade)
  amount        Float
  paymentDate   DateTime
  paymentMethod String?   // cash, bank, upi, cheque
  notes         String?
  createdBy     String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([partyId])
  @@index([paymentDate])
}

// Transaction model - buy/sell transactions with daily tracking
model Transaction {
  id            String        @id @default(cuid())
  type          String        // 'buy' or 'sell'
  date          DateTime      // Transaction date for daily/monthly/quarterly/yearly filtering
  partyId       String
  phone         String
  totalWeight   Float
  totalPayment  Float
  notes         String?
  
  // Image attachments (invoices, receipts, etc.)
  invoiceImage  String?       // Cloudinary URL
  receiptImage  String?       // Cloudinary URL
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  // Relations
  createdBy     String
  creator       User          @relation(fields: [createdBy], references: [id])
  party         Party         @relation(fields: [partyId], references: [id])
  buyItems      BuyItem[]
  sellItems     SellItem[]
  
  @@index([type])
  @@index([date])
  @@index([partyId])
  @@index([createdBy])
  @@index([createdAt])
}

// BuyItem model - items purchased in buying transactions
model BuyItem {
  id                   String        @id @default(cuid())
  transactionId        String
  hnyColor             Float         // Honey color weight (kg)
  hnyRate              Float?        // Honey color rate (₹/kg) - optional for existing data
  blackColor           Float         // Black color weight (kg)
  blackRate            Float?        // Black color rate (₹/kg) - optional for existing data
  transportationCharges Float        @default(0) // Transportation charges
  createdAt            DateTime      @default(now())
  
  // Relations
  transaction          Transaction   @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  
  @@index([transactionId])
}

// SellItem model - items sold in selling transactions
model SellItem {
  id                   String        @id @default(cuid())
  transactionId        String
  itemName             String        // Item name (e.g., "Shoes HNY", "Sheet Black")
  count                Float         // Number of items
  weightPerItem        Float         // Weight per item in kg
  ratePerItem          Float         // Rate per item (₹/item) - NOT per kg
  totalWeight          Float         // count × weightPerItem
  totalAmount          Float         // count × ratePerItem
  transportationCharges Float        @default(0) // Transportation charges
  paymentDueDays       Int?          // Payment due in days (optional)
  paymentReceived      Float         @default(0) // DEPRECATED: Calculated from payments
  balanceLeft          Float         @default(0) // DEPRECATED: Calculated from payments
  createdAt            DateTime      @default(now())
  
  // Relations
  transaction          Transaction   @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  payments             Payment[]     // Individual payment records
  
  @@index([transactionId])
}

// Payment model - individual payment records for audit trail
model Payment {
  id            String    @id @default(cuid())
  sellItemId    String
  sellItem      SellItem  @relation(fields: [sellItemId], references: [id], onDelete: Cascade)
  amount        Float     // Amount received in this payment
  paymentDate   DateTime  // When payment was received
  paymentMethod String?   // cash, bank, upi, cheque
  notes         String?   // Optional notes for this payment
  createdBy     String    // User who recorded the payment
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([sellItemId])
  @@index([paymentDate])
  @@index([createdBy])
}

// Report model - for storing generated reports
model Report {
  id             String        @id @default(cuid())
  name           String
  type           String        // 'daily', 'monthly', 'quarterly', 'yearly', 'custom'
  startDate      DateTime
  endDate        DateTime
  data           Json          // Store report data as JSON
  generatedBy    String
  createdAt      DateTime      @default(now())
  
  @@index([type])
  @@index([createdAt])
}

// Notification model - for admin alerts
model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  message   String
  type      String   // 'create', 'update', 'delete'
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  
  @@index([userId, isRead])
  @@index([createdAt])
}
